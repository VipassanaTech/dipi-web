<?php

include_once(dirname(__FILE__)."/address-book.inc");


/**
 * Implements hook_permission().
 */
function dh_atportal_permission() 
{

	$perms['access at portal'] = array('title' => t('Access AT Portal') ) ;
	$perms['access at address book'] = array('title' => t('Access AT Address Book') );
	$perms['access at profile'] = array('title' => t('Access AT Profile') );
	$perms['access any profile'] = array('title' => t('Access Any AT Profile') );
	$perms['add assistant teacher'] = array('title' => t('Add AT'));
	return $perms;
}


function dh_atportal_menu() 
{
    $items['at-portal'] = array( 'title' => t('AT Portal Dashboard'),
	       'page callback' => 'dh_atportal_dashboard',
	       'access arguments' => array('access at portal'),
	       'type' => MENU_CALLBACK);

    $items['lc-review/%atcode'] = array( 'title' => t('Reviews Assigned to me'),
	       'page callback' => 'dh_atportal_show_apps',
	       'page arguments' => array('me'),
	       'access arguments' => array('access at portal'),
	       'type' => MENU_CALLBACK);

    $items['lc-review/all'] = array( 'title' => t('All Reviews'),
	       'page callback' => 'dh_atportal_show_apps',
	       'page arguments' => array('all'),
	       'access arguments' => array('access at portal'),
	       'type' => MENU_CALLBACK);

    $items['lc-review/app/%lcappid'] = array( 'title' => t('Review Application'),
	       'page callback' => 'drupal_get_form',
	       'page arguments' => array('dh_atportal_review_form', 2),
	       'access arguments' => array('access at portal'),
	       'type' => MENU_CALLBACK);

    $items['at-portal/address-book/edit/%atcode'] = array( 'title' => t('My Profile'),
	       'page callback' => 'drupal_get_form',
	       'page arguments' => array('dh_atportal_profile', 2),
	       'access arguments' => array('access at profile'),
	       'type' => MENU_CALLBACK);

    $items['at-portal/address-book'] = array( 'title' => t('AT Address Book'),
	       'page callback' => 'dh_atportal_address_book',
	       'access arguments' => array('access at address book'),
	       'type' => MENU_CALLBACK);

    $items['at-portal/address-book/add'] = array( 'title' => t('Add AT'),
	       'page callback' => 'drupal_get_form',
	       'page arguments' => array('dh_atportal_profile', 'new'),
	       'access arguments' => array('add assistant teacher'),
	       'type' => MENU_CALLBACK);


    return $items;
}


function dh_atportal_theme()
{
	return array(
		// Name to be called with theme(). theme('lc-review', $data)
		'lc-review' => array(
			// Which .tpl.php file to use lc-review.tpl.php
			'template' => 'lc-review',
			'path' => drupal_get_path('module', 'dh_atportal')
		)
	);
}

function lcappid_load( $id )
{
	global $user;
	if ( ! is_numeric($id) )
		return false;

	$centre_id = db_query("select a_center from dh_applicant where a_id='$id'")->fetchField();
	if ($centre_id == '')
		return false;
	if (user_access("access at portal"))
		return $id;
	/*$count = db_query("select count(uc_id) from dh_user_center where uc_center='$centre_id' and uc_user='".$user->uid."'  and uc_deleted=0")->fetchField();
	if ( $count <= 0  )
		return false;

	$gender = db_query("select a_gender from dh_applicant where a_id=$id")->fetchField();
	$gender = strtoupper($gender);
	if (($gender == 'M') && (! user_access('access male')))
		return false;		

	if (($gender == 'F') && (! user_access('access female')))
		return false;
	*/
	return $id;
}


function atcode_load( $id )
{
	return True;
}

function dh_atportal_dashboard()
{
	$out = '<h1>AT Portal Dashboard</h1><ul><li><h2>'.l("Reviews Assigned to me", "lc-review/me").'</h2></li>'.
	'<li><h2>'.l("All Reviews", "lc-review/all").'</h2></li>'.
	'<li><h2>'.l("My Profile", "at-portal/address-book/edit/an3.m").'</h2></li>'.
	'<li><h2>'.l("AT Address Book", "at-portal/address-book").'</h2></li>'.
	'</ul>';
	return $out;
}

function dh_atportal_show_apps( $type )
{
	$out = drupal_get_form('dh_atportal_apps_form', $type);
	return $out;
}

function dh_atportal_make_pretty( $value )
{
	$ret = '';
	switch($value)
	{
		case 'Pending': 
			$ret = '<font color="blue"><b>'.$value.'</b></font>';
			break;
		case 'Approved': 
			$ret = '<font color="green"><b>'.$value.'</b></font>';
			break;
		case 'Rejected': 
			$ret = '<font color="red"><b>'.$value.'</b></font>';
			break;
	}
	return $ret;
}

function dh_atportal_apps_form($form, &$form_state, $type)
{
	/*if ($type == 'me')
		drupal_set_title('Reviews Assigned to me');
	else
		drupal_set_title('All Reviews');
	*/
	$at_code = '';
	if (arg(1) <> '' )
		$at_code = arg(1);
	$q = "select CONCAT(t_f_name, ' ', t_l_name) from dh_teacher where CONCAT(t_code,'.',t_gender) = '$at_code' limit 1";
	$at_name = db_query($q)->fetchField();

	if ($at_name == '')
	{
		$form['a'] = array('#markup' => '<h2>Unable to find applications for '.$at_name.' </h2>');	
		return $form;
	}
	$iPod    = stripos($_SERVER['HTTP_USER_AGENT'],"iPod");
	$iPhone  = stripos($_SERVER['HTTP_USER_AGENT'],"iPhone");
	$iPad    = stripos($_SERVER['HTTP_USER_AGENT'],"iPad");
	drupal_add_css( libraries_get_path("editor"). "/DataTables/datatables.min.css");
	//drupal_add_js( libraries_get_path("editor").  "/DataTables/datatables.min.js");
	//drupal_add_js(drupal_get_path('module', 'dh_manageapp').'/js/location-common.js');
	if ( !($iPad || $iPhone || $iPod) )
	{
		//drupal_add_js( libraries_get_path("editor").  "/DataTables/Buttons-1.5.1/js/buttons.html5.min.js");
		drupal_add_js( libraries_get_path("editor").  "/DataTables/Buttons-1.5.1/js/buttons.print.min.js");
	}

	drupal_add_css( drupal_get_path('module', 'dh_manageapp'). "/css/jquery-confirm.min.css");
	drupal_add_js( drupal_get_path('module', 'dh_manageapp'). "/js/jquery-confirm.min.js");
	
	//drupal_add_css(drupal_get_path('module', 'dh_manageapp').'/css/tables.css' );


	//$form['a'] = array('#markup' => 'Hi there, I am '.$at_name);
	$q = "select CONCAT(a_f_name, ' ', a_l_name) as 'Student Name', a_email as 'Email', a_phone_mobile, a_gender as 'Gender', a_type as 'Sit/Serve', co.c_name as 'Country', s.s_name as 'State',  cr.c_name as 'CourseName', DATE_FORMAT(cr.c_start, '%d %b') as 'CourseStart', DATE_FORMAT(cr.c_end, '%d %b, %Y') as 'CourseEnd', td.td_val1 as 'CourseType', ce.c_name as 'Centre', al.al_recommending_approved, al.al_area_at_approved, DATEDIFF(CURDATE(), cr.c_start) as 'diff',
		a_uri, a_id
		from dh_applicant_lc al left join dh_applicant a on (al.al_applicant=a.a_id) left join dh_country co on a.a_country=co.c_code left join dh_state s on (a.a_country=s.s_country and a.a_state=s.s_code) left join dh_center ce on (a.a_center=ce.c_id) left join dh_course cr on a.a_course=cr.c_id left join dh_type_detail td on cr.c_course_type=td.td_id where
		(al.al_recommending = '$at_name' or al.al_area_at='$at_name') and DATEDIFF(CURDATE(), cr.c_start) <= 730  order by a_created desc";
	$result = db_query($q);
	$rows_completed = $rows_pending = array();
	while( $r = $result->fetchAssoc() )
	{
		unset($rs);
		$rs = array();
		if ($r['diff'] <= 0)
			$rs[] = l('Details', "lc-review/app/".$r['a_id']);
		$rs[] = dh_atportal_make_pretty($r['al_recommending_approved']);
		$rs[] = dh_atportal_make_pretty($r['al_area_at_approved']);
		$rs[] = $r['Centre'];
		$rs[] = $r['CourseType'];
		$rs[] = $r['CourseStart']." - ".$r['CourseEnd'];
		$pdf_link = '';
		if ( $r['a_uri'] <> '' )
			$pdf_link = '&nbsp;('.l("PDF", file_create_url($r['a_uri']), array('attributes' => array("target" => "_blank") ) ).')';

		$rs[] = $r['Student Name'].$pdf_link."<br>".$r['Gender']."&nbsp;|&nbsp;".(($r['Sit/Serve']=='Student')?'Sit':'Serve');
		$rs[] = $r['Email']."<br>".$r['a_phone_mobile'];
		$rs[] = $r['Country'].", ".$r['State'];
		if ($r['diff'] > 0)
			$rows_completed[] = array_values($rs);
		else
			$rows_pending[] = array_values($rs);
	}	

	$header = array('Action', 'Reco AT', 'Area AT', 'Centre', 'CourseType', 'Course Start/End', 'Applicant Name', 'Email/Contact',  'Country/State');
	$attributes = array('id' => 'applications-pending');

	$out = theme('table', array('header' => $header, 'rows' => $rows_pending, 'attributes' => $attributes));
	$form['a'] = array('#markup' => '<h2>Pending Courses</h2>'.$out);

	$header = array('Reco AT', 'Area AT', 'Centre', 'CourseType', 'Course Start/End', 'Applicant Name', 'Email/Contact',  'Country/State');
	$attributes = array('id' => 'applications-completed');
	$out = theme('table', array('header' => $header, 'rows' => $rows_completed, 'attributes' => $attributes));
	$form['b'] = array('#type' => 'fieldset','#title' => '<h2>Completed Courses - Click to open</h2>' , '#collapsible' => true, '#collapsed' => true);
	$form['b']['c'] = array('#markup' => $out);
	
	return $form;
}

function dh_atportal_review_form($form, &$form_state, $appid )
{
	drupal_add_css(drupal_get_path('module', 'dh_manageapp').'/css/select2.min.css');
	drupal_add_js(drupal_get_path('module', 'dh_manageapp').'/js/select2.min.js');

	$q = "select CONCAT(a_f_name, ' ', a_m_name, ' ', a_l_name) as 'Name', a_id, a_center, a_course, c.c_name, c.c_start, a_status,a_city_str, a_photo,  
		co.c_name as 'Country', s.s_name as 'State', cci.c_name as 'City', a_email, a_phone_mobile, DATE_FORMAT(a_dob, '%d %b, %Y' ) as 'DOB', TIMESTAMPDIFF( YEAR, a_dob, CURDATE() ) as 'Age', a_uri,  
		ac.*, al.* from dh_applicant a left join dh_course c on (a.a_course=c.c_id) left join dh_applicant_lc al on (a_id=al_applicant) left join dh_applicant_course ac on (a_id=ac_applicant) left join dh_country co on a.a_country=co.c_code left join dh_state s on (a.a_country=s.s_country and a.a_state=s.s_code) left join dh_city cci on a.a_city=cci.c_id where  a_id =$appid";
	$result = db_query($q);
	$r = $result->fetchAssoc();
	if ($r['City'] == '')
		$r['City'] = $r['a_city_str'];
	if ($r['a_photo'])
		$r['a_photo'] = file_create_url($r['a_photo']);
	$pdf_link = '';
	if ( $r['a_uri'] <> '' )
		$pdf_link = '&nbsp;('.l("PDF", file_create_url($r['a_uri']), array('attributes' => array("target" => "_blank") ) ).')';
		$r['a_uri'] = $pdf_link;
	$r['al_reco_status'] = dh_atportal_make_pretty($r['al_recommending_approved']);
	if ($r['al_recommending'])
		$r['al_reco_status'] .= "&nbsp;&nbsp;(&nbsp;".$r['al_recommending']."&nbsp;)";
	$r['al_area_status'] = dh_atportal_make_pretty($r['al_area_at_approved']);
	if ($r['al_area_at'])
		$r['al_area_status'] .= "&nbsp;&nbsp;(&nbsp;".$r['al_area_at']."&nbsp;)";
	$out = theme('lc-review', array('data' => $r));
	$form = array();
	$form['a'] = array('#markup' => $out);


	$q = "select l_msg , name, l_tstamp from dh_log left join users on l_user=uid where l_module='Applicant' and l_identifier='".$r['a_id']."' and l_event in ('Status Change', 'Letter', 'LC Workflow') order by l_tstamp desc";
	$res = db_query($q);
	$rows = array();
	while( $row = $res->fetchAssoc())
	{
		$r = array();
		$r[] = $row['l_tstamp'];
		$r[] = $row['l_msg'];
		$r[] = $row['name'];
		$rows[] = $r;
	}
	$header = array('DateTime', 'Activity', 'User');
	$out = '';
	if (!empty($rows))
		$out .= theme('table', array('header' => $header, 'rows' => $rows)) ;

	$form['b'] = array('#type' => 'fieldset','#title' => '<h2>Activity Log - Click to open</h2>' , '#collapsible' => true, '#collapsed' => true);
	$form['b']['c'] = array('#markup' => $out);

	$options_area_t = db_query("select CONCAT(t_f_name, ' ', t_l_name) as 'name', CONCAT(t_f_name, ' ', t_l_name, '  ', IF(t_area != '', CONCAT('(',t_area,')'), '')) as 'area' from dh_teacher where (t_cat=1 or t_full_t=1) order by t_f_name, t_l_name")->fetchAllKeyed();
	$options_area_t[''] = 'Select CAT/T';

	$form['action'] = array('#type' => 'select',  '#options' => array( '' => 'Choose Action', 'approve' => 'Approve', 'reject' => 'Reject'));
	$form['area_teacher'] = array('#type' => 'select', '#options' => $options_area_t, '#title' => 'Select Area Teacher');
	$form['reco_comments'] = array('#type' => 'textarea', '#rows' => 3, '#title' => 'Comments');
	$form['sub'] = array('#type' => 'submit',  '#value' => 'Submit Review');

	$js = '
		(function ($) {
			$(document).ready(function(){
				$("#edit-area-teacher").select2();
			});
		})(jQuery);
	';
	drupal_add_js($js, 'inline');

	return $form;
}


function dh_atportal_review_form_submit($form, &$form_state )
{
	drupal_set_message("I am called");

}
